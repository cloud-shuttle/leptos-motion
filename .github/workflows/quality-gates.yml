name: ADR-Compliant Quality Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Code Quality Gates (ADR-003: Rust Coding Practices)
  code-quality:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          target: wasm32-unknown-unknown
          override: true
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Check formatting (ADR-003)
        run: cargo fmt --all -- --check
        
      - name: Run clippy (ADR-003)
        run: cargo clippy --all-targets --all-features -- -D warnings
        
      - name: Check WASM compatibility
        run: cargo check --target wasm32-unknown-unknown --all-features

  # Testing Quality Gates (ADR-004: Testing Strategy)
  testing-quality:
    name: Testing Quality Gates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Run unit tests (70% of testing pyramid)
        if: matrix.test-type == 'unit'
        run: cargo test --lib --bins --tests
        
      - name: Run integration tests (20% of testing pyramid)
        if: matrix.test-type == 'integration'
        run: cargo test --test '*' --features integration
        
      - name: Setup Node.js for E2E tests (10% of testing pyramid)
        if: matrix.test-type == 'e2e'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install pnpm
        if: matrix.test-type == 'e2e'
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        if: matrix.test-type == 'e2e'
        run: pnpm install
        
      - name: Install Playwright browsers
        if: matrix.test-type == 'e2e'
        run: pnpm exec playwright install --with-deps
        
      - name: Run E2E tests
        if: matrix.test-type == 'e2e'
        run: pnpm test:e2e

  # Coverage Quality Gates (ADR-004: Testing Strategy)
  coverage-quality:
    name: Coverage Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
        
      - name: Generate coverage report
        run: cargo tarpaulin --out Html --output-dir coverage --fail-under 95
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/cobertura.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  # Security Quality Gates
  security-quality:
    name: Security Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Install cargo-audit
        run: cargo install cargo-audit
        
      - name: Run security audit
        run: cargo audit
        
      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@v1
        with:
          command: check
          args: --all-features

  # Performance Quality Gates
  performance-quality:
    name: Performance Quality Gates
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Run benchmarks
        run: |
          if cargo bench --help &> /dev/null; then
            cargo bench --no-run
          else
            echo "Criterion benchmarks not available, skipping"
          fi

  # Documentation Quality Gates
  documentation-quality:
    name: Documentation Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Check documentation builds
        run: cargo doc --no-deps --all --document-private-items
        
      - name: Check for missing documentation
        run: cargo doc --no-deps --all --document-private-items 2>&1 | grep -q "missing documentation" && exit 1 || exit 0

  # Final Quality Gate - All checks must pass
  quality-gate:
    name: Final Quality Gate
    runs-on: ubuntu-latest
    needs: [code-quality, testing-quality, coverage-quality, security-quality, documentation-quality]
    if: always()
    steps:
      - name: Check all quality gates
        run: |
          if [[ "${{ needs.code-quality.result }}" != "success" || 
                "${{ needs.testing-quality.result }}" != "success" || 
                "${{ needs.coverage-quality.result }}" != "success" || 
                "${{ needs.security-quality.result }}" != "success" || 
                "${{ needs.documentation-quality.result }}" != "success" ]]; then
            echo "❌ Quality gates failed"
            exit 1
          else
            echo "✅ All quality gates passed"
          fi
